// Production Prisma Schema - Use PostgreSQL
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int       @id @default(autoincrement())
  supabaseId          String?   @unique
  email               String    @unique
  passwordHash        String?
  name                String?
  phone               String?
  country             String?
  
  // Exchange credentials (encrypted)
  binanceApiKeyEnc    String?
  binanceApiSecretEnc String?
  binanceConnectedAt  DateTime?
  
  emailVerified       Boolean   @default(false)
  emailVerifyToken    String?
  createdAt           DateTime  @default(now())
  googleId            String?   @unique
  
  // Subscription
  subscriptionPlan    String?
  subscriptionStatus  String?
  subscriptionExpires DateTime?
  
  // Relations
  strategies          Strategy[]
  strategyRuns        StrategyRun[]
  trades              Trade[]
  backtestResults     BacktestResult[]

  @@index([email])
  @@index([supabaseId])
}

model Strategy {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  category    String?
  
  config      String
  pairs       String
  maxDeals    Int      @default(5)
  orderSize   Float    @default(1000)
  
  lastBacktestProfit    Float?
  lastBacktestDrawdown  Float?
  lastBacktestSharpe    Float?
  lastBacktestWinRate   Float?
  
  isPublic    Boolean  @default(false)
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  runs        StrategyRun[]
  backtests   BacktestResult[]

  @@index([userId])
  @@index([isPublic])
}

model StrategyRun {
  id          Int       @id @default(autoincrement())
  
  config      String
  pairs       String
  exchange    String    @default("binance")
  
  status      String    @default("running")
  startedAt   DateTime  @default(now())
  stoppedAt   DateTime?
  
  initialBalance  Float
  currentBalance  Float?
  totalProfit     Float?
  totalTrades     Int     @default(0)
  winningTrades   Int     @default(0)
  maxDrawdown     Float?
  
  lastError   String?
  errorCount  Int       @default(0)
  
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategyId  Int
  strategy    Strategy  @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  trades      Trade[]

  @@index([userId])
  @@index([strategyId])
  @@index([status])
}

model Trade {
  id            Int      @id @default(autoincrement())
  
  symbol        String
  side          String
  type          String   @default("market")
  quantity      Float
  price         Float
  amount        Float
  fee           Float?
  
  entryPrice    Float?
  exitPrice     Float?
  profitLoss    Float?
  profitPercent Float?
  
  status        String   @default("pending")
  orderId       String?
  
  comment       String?
  marketState   String?
  createdAt     DateTime @default(now())
  executedAt    DateTime?
  
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategyRunId Int?
  strategyRun   StrategyRun? @relation(fields: [strategyRunId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([strategyRunId])
  @@index([symbol])
  @@index([createdAt])
}

model BacktestResult {
  id          Int      @id @default(autoincrement())
  name        String
  
  config      String
  pairs       String
  startDate   DateTime
  endDate     DateTime
  initialBalance Float
  
  netProfit       Float
  netProfitUsd    Float
  maxDrawdown     Float
  sharpeRatio     Float
  sortinoRatio    Float
  winRate         Float
  totalTrades     Int
  profitFactor    Float
  yearlyReturn    Float
  
  chartData   String?
  trades      String?
  
  createdAt   DateTime @default(now())
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategyId  Int?
  strategy    Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([strategyId])
  @@index([createdAt])
}

model Comment {
  id        Int      @id @default(autoincrement())
  author    String?
  text      String
  photo     String?
  createdAt DateTime @default(now())
}

